#cloud-config

write_files:
- path: /etc/systemd/system/avalanche@.service
  content: |
    [Unit]
    Description="Avalanche scrape target at port %i"
    After=network.target
    PartOf=avalanche-targets.target
    
    [Service]
    Type=simple
    Restart=always
    ExecStart=/usr/bin/avalanche --port=%i \
                --metric-count=${METRIC_COUNT} \
                --label-count=10 \
                --series-count=10 \
                --value-interval=${VALUE_INTERVAL} \
                --series-interval=36000000 \
                --metric-interval=36000000

- path: /etc/systemd/system/avalanche-targets.target
  content: |
    [Unit]
    Description=A collection of avalanche scrape targets
    Wants=%{ for i in range(NUM_TARGETS) ~}avalanche@${9001 + i}.service %{ endfor ~}

package_update: true

packages:
- golang-go

runcmd:
- |
  set -eux
  mkdir -p /go/.cache /go/bin && HOME=/go GOPATH=/go GOCACHE=/go/.cache go get github.com/prometheus-community/avalanche/cmd/...
  mv /go/bin/cmd /usr/bin/avalanche
  
  systemctl daemon-reload
  systemctl start avalanche-targets.target

