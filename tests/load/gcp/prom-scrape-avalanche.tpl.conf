#cloud-config

write_files:
- path: /run/start_avalanche
  content: |
    #!/bin/bash
    set -euxo pipefail
    for ((i = 1 ; i <= 20 ; i++)) ; do 
        port=$((9000 + $i))
        nohup avalanche \
        --metric-count=${METRIC_COUNT} \
        --label-count=10 \
        --series-count=10 \
        --value-interval=${VALUE_INTERVAL} \
        --series-interval=36000000 \
        --metric-interval=36000000 \
        --port="$${port}" 1>/dev/null 2>&1 & 
    done

package_update: true

packages:
- golang-go

runcmd:
- |
  mkdir -p /go/.cache /go/bin && HOME=/go GOPATH=/go GOCACHE=/go/.cache go install github.com/open-fresh/avalanche/cmd/...@latest
  mv /go/bin/cmd /usr/bin/avalanche
  bash /run/start_avalanche

