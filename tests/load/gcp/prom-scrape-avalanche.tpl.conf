#cloud-config

write_files:
- path: /etc/systemd/system/avalanche@.service
  content: |
    [Unit]
    Description="Avalanche scrape target at port %i"
    After=network.target
    PartOf=avalanche-targets.target
    
    [Service]
    Type=simple
    Restart=always
    ExecStart=/usr/bin/avalanche --port=%i \
                --metric-count=${METRIC_COUNT} \
                --label-count=10 \
                --series-count=10 \
                --value-interval=${VALUE_INTERVAL} \
                --series-interval=36000000 \
                --metric-interval=36000000

- path: /etc/systemd/system/avalanche-targets.target
  content: |
    [Unit]
    Description=A collection of avalanche scrape targets
    Wants=avalanche@9001.service avalanche@9002.service avalanche@9003.service avalanche@9004.service \
          avalanche@9005.service avalanche@9006.service avalanche@9007.service avalanche@9008.service \
          avalanche@9009.service avalanche@9010.service avalanche@9011.service avalanche@9012.service \
          avalanche@9013.service avalanche@9014.service avalanche@9015.service avalanche@9016.service \
          avalanche@9017.service avalanche@9018.service avalanche@9019.service avalanche@9020.service

package_update: true

packages:
- golang-go

runcmd:
- |
  set -eux
  mkdir -p /go/.cache /go/bin && HOME=/go GOPATH=/go GOCACHE=/go/.cache go install github.com/open-fresh/avalanche/cmd/...@latest
  mv /go/bin/cmd /usr/bin/avalanche
  
  systemctl daemon-reload
  systemctl start avalanche-targets.target

