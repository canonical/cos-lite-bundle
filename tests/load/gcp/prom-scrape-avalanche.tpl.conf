#cloud-config

write_files:
- path: /etc/systemd/system/node-exporter.service
  content: |
    [Unit]
    Description=Node exporter
    After=network.target

    [Service]
    Type=simple
    Restart=always
    RestartSec=5
    ExecStartPre=wget https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz -P /run
    ExecStartPre=tar -xzvf /run/node_exporter-1.3.1.linux-amd64.tar.gz -C /run
    ExecStartPre=mv /run/node_exporter-1.3.1.linux-amd64/node_exporter /usr/bin
    ExecStart=/usr/bin/node_exporter \
                --web.listen-address=":29100" \
                --web.disable-exporter-metrics \
                --collector.disable-defaults \
                --collector.cpu \
                --collector.diskstats \
                --collector.ethtool \
                --collector.filesystem \
                --collector.hwmon \
                --collector.loadavg \
                --collector.meminfo \
                --collector.netdev \
                --collector.pressure
- path: /etc/systemd/system/avalanche@.service
  content: |
    [Unit]
    Description="Avalanche scrape target at port %i"
    After=network.target
    PartOf=avalanche-targets.target

    [Service]
    Type=simple
    Restart=always
    ExecStart=/usr/bin/avalanche --port=%i \
                --metric-count=${METRIC_COUNT} \
                --label-count=10 \
                --series-count=10 \
                --value-interval=${VALUE_INTERVAL} \
                --series-interval=36000000 \
                --metric-interval=36000000

- path: /etc/systemd/system/avalanche-targets.target
  content: |
    [Unit]
    Description=A collection of avalanche scrape targets
    Wants=%{ for i in range(NUM_TARGETS) ~}avalanche@${9001 + i}.service %{ endfor ~}

package_update: true

packages:
- golang-go
- kitty-terminfo

runcmd:
- |
  set -eux
  mkdir -p /go/.cache /go/bin && HOME=/go GOPATH=/go GOCACHE=/go/.cache go install github.com/prometheus-community/avalanche/cmd@19b624b
  mv /go/bin/cmd /usr/bin/avalanche

  systemctl daemon-reload
  systemctl start avalanche-targets.target
  systemctl start node-exporter.service
