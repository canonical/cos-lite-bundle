#cloud-config

write_files:
- path: /etc/systemd/system/locust.service
  content: |
    [Unit]
    Description=prom query locust
    After=network.target

    [Service]
    Type=simple
    Restart=always
    ExecStart=python3 -m locust -f /home/ubuntu/prom-query-locustfile.py --host ${PROM_URL} --users ${USERS} --spawn-rate 10 --headless

package_update: true

packages:
- python3-pip
- jq

runcmd:
- |
  set -eux
  
  # install deps
  python3 -m pip install locust
  
  # wait until the lma node is up
  timeout 1800 bash -c "until curl -s --connect-timeout 2.0 --max-time 5 ${PROM_URL}/api/v1/targets; do sleep 5; done"
  
  # without piping to jq, curl would return successfully with "nginx 404 not found"
  # TARGETS=0; until [ $TARGETS -gt 1 ]; do TARGETS=$(curl -s --connect-timeout 2.0 ${PROM_URL}/api/v1/targets | jq '.data.activeTargets[].health' 2>/dev/null | wc -l); sleep 5; done
  
  timeout 600 bash << 'EOF'
  set -euxo pipefail

  _num_targets() {
    echo "$(curl -s --connect-timeout 2 --max-time 5 ${PROM_URL}/api/v1/targets \
            | jq '.data.activeTargets[].health' \
            | wc -l)"
  }

  until [[ "$(_num_targets)" -gt 1 ]]; do sleep 5; done
  EOF
  
  # now that prom is really reachable, start locust
  systemctl daemon-reload
  systemctl start locust.service

