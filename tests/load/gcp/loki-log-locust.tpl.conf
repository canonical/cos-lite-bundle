#cloud-config

write_files:
- path: /etc/systemd/system/locust.service
  content: |
    [Unit]
    Description=logi log locust
    After=network.target

    [Service]
    Type=simple
    Restart=always
    ExecStart=python3 -m locust -f /home/ubuntu/loki-log-locustfile.py --host ${LOKI_URL} --users ${USERS} --spawn-rate 10 --headless

package_update: true

packages:
- python3-pip
- jq

runcmd:
- |
  set -eux

  # install deps
  python3 -m pip install locust

  # wait until the cos-lite node is up
  timeout 1800 bash -c "until curl -s --connect-timeout 2.0 --max-time 5 ${LOKI_URL}/ready; do sleep 5; done"

  timeout 600 bash << 'EOF'
  set -eux

  _is_ready() {
    echo "$(curl -s --connect-timeout 2 --max-time 5 ${LOKI_URL}/ready \
            | grep '^ready$' \
            | wc -l)"
  }

  until [[ "$(_is_ready)" -eq 1 ]]; do sleep 5; done
  EOF

  # now that loki is really ready, start locust
  systemctl daemon-reload
  systemctl start locust.service

