#cloud-config

write_files:
- path: /run/agent.yaml
  content: |
    metrics:
      global:
        scrape_interval: 15s
        scrape_timeout: 10s
        remote_write:
          - url: ${REMOTE_WRITE_URL}
            basic_auth:
              username: ${REMOTE_WRITE_USERNAME}
              password: ${REMOTE_WRITE_PASSWORD}
      configs:
      - name: default
        scrape_configs:
        - job_name: 'cos-appliance-grafana-self'
          static_configs:
          - targets: ['${TARGET_COS_APPLIANCE_GRAFANA}']
          metrics_path: '${METRICS_PATH_GRAFANA}'

        - job_name: 'cos-appliance-loki-self'
          static_configs:
          - targets: ['${TARGET_COS_APPLIANCE_LOKI}']
          metrics_path: '${METRICS_PATH_LOKI}'

        - job_name: 'cos-appliance-prom-self'
          static_configs:
          - targets: ['${TARGET_COS_APPLIANCE_PROM}']
          metrics_path: '${METRICS_PATH_PROM}'

        - job_name: 'cos-appliance-node-exporter'
          static_configs:
          - targets: [ '${TARGET_COS_EXPORTER}' ]

        - job_name: 'loki-log-node-exporter'
          static_configs:
          - targets: [ ${TARGET_LOKI_LOG_EXPORTER} ]

        - job_name: 'prom-query-node-exporter'
          static_configs:
          - targets: [ ${TARGET_PROM_QUERY_EXPORTER} ]

        - job_name: 'prom-scrape-node-exporter'
          static_configs:
          - targets: [ '${TARGET_PROM_SCRAPE_EXPORTER}' ]
- path: /etc/systemd/system/grafana-agent.service
  content: |
    [Unit]
    Description=Grafana agent
    After=network.target

    [Service]
    Type=simple
    Restart=always
    RestartSec=5
    ExecStartPre=wget https://github.com/grafana/agent/releases/download/v0.28.0/agent-linux-amd64.zip -P /run
    ExecStartPre=unzip /run/agent-linux-amd64.zip -d /run
    ExecStartPre=chmod a+x /run/agent-linux-amd64
    ExecStartPre=mv /run/agent-linux-amd64 /usr/bin
    ExecStart=/usr/bin/agent-linux-amd64 \
                -config.file=/run/agent.yaml \
                -metrics.wal-directory="/home/ubuntu/data"

package_update: true

packages:
- unzip
- kitty-terminfo
- iputils-ping

runcmd:
- |
  systemctl daemon-reload
  systemctl start grafana-agent.service
