# Charm Pebble health checks
command:
  {{ if .Vars.enable_pebble_tests }}
  # $root is required to access the root context of the current template,
  # which refers to the entire data structure being passed into the template.
  # This provides access to .Vars and .Env in loops like the one below.
  {{- $root := . -}}
  {{range $app := .Vars.apps.k8s}}
  pebble-{{$app.name}}:
    exec: juju ssh -m {{ $root.Vars.model_name }} {{$app.name}}/0 /charm/bin/pebble health
    exit-status: 0
    stdout:
      have-patterns:
      - healthy
    stderr: ""
  {{end}}
  k8s-charms:
    exec: bash goss/scripts/test-k8s-probes.sh
    exit-status: 0
    stdout: ""
    stderr: ""
  {{end}}